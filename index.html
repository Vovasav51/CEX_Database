<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–í—ñ–¥–æ–º–æ—Å—Ç—ñ –∑ Firestore</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
// ===== Firebase =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCeE3Sm3omKS3CvZEAUrDWNy75CQMSYFYs",
  authDomain: "cex-database.firebaseapp.com",
  projectId: "cex-database",
  storageBucket: "cex-database.firebasestorage.app",
  messagingSenderId: "140570970101",
  appId: "1:140570970101:web:f27b59f08c865bae0f42bc",
  measurementId: "G-CP4E1QQKRW"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let tableData = [];

// ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ Firestore =====
async function loadFromFirestore() {
  const querySnapshot = await getDocs(collection(db, "uploads"));
  tableData = [];
  querySnapshot.forEach(doc => tableData.push(doc.data()));
  renderTable(tableData);
}

// ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è CSV/Excel —É Firestore =====
document.getElementById('fileInput').addEventListener('change', async function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

    tableData = sheet;
    renderTable(sheet);

    // –ó–±–µ—Ä–µ–≥—Ç–∏ —É Firestore
    for (let row of sheet) {
      await addDoc(collection(db, "uploads"), row);
    }
    alert("–î–∞–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É Firestore!");
  };
  reader.readAsArrayBuffer(file);
});

// ===== –ü–æ–±—É–¥–æ–≤–∞ —Ç–∞–±–ª–∏—Ü—ñ =====
function renderTable(data) {
  const tableHead = document.getElementById('tableHead');
  const tableBody = document.getElementById('tableBody');
  tableHead.innerHTML = "";
  tableBody.innerHTML = "";

  if (data.length === 0) return;

  // –ó–∞–≥–æ–ª–æ–≤–∫–∏
  const headerRow = document.createElement('tr');
  Object.keys(data[0]).forEach(key => {
    const th = document.createElement('th');
    th.textContent = key;
    headerRow.appendChild(th);
  });
  tableHead.appendChild(headerRow);

  // –†—è–¥–∫–∏
  data.forEach(row => {
    const tr = document.createElement('tr');
    Object.values(row).forEach(value => {
      const td = document.createElement('td');
      td.textContent = value;
      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
}

// ===== –ï–∫—Å–ø–æ—Ä—Ç —É Excel =====
document.getElementById('exportBtn').addEventListener('click', function() {
  if (tableData.length === 0) {
    alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É!");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(tableData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "–í—ñ–¥–æ–º–æ—Å—Ç—ñ");
  XLSX.writeFile(wb, "vydomosti.xlsx");
});

// –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
loadFromFirestore();
</script>
</head>
<body>
<h1>–í—ñ–¥–æ–º–æ—Å—Ç—ñ –∑ Firestore</h1>

<input type="file" id="fileInput" accept=".csv, .xlsx, .xls">
<button id="exportBtn">üíæ –í–∏–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é</button>

<table border="1" id="dataTable">
  <thead id="tableHead"></thead>
  <tbody id="tableBody"></tbody>
</table>

</body>
</html>
